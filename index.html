<script>
    const proxyUrl = "http://localhost:3000/"; // URL del servidor backend

    async function actualizarStock() {
        try {
            let tableBody = document.getElementById("stockTable");
            tableBody.innerHTML = '<tr><td colspan="3">Cargando productos...</td></tr>';

            // ✅ Obtener productos desde el servidor backend
            let response = await fetch(`${proxyUrl}productos`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            });

            if (!response.ok) {
                throw new Error("Error al obtener productos");
            }

            let data = await response.json();
            let productIDs = data.results; // Lista de IDs obtenidos

            if (productIDs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3">No hay productos activos</td></tr>';
                return;
            }

            // ✅ Dividir los IDs en grupos de 20 (MercadoLibre permite máximo 20 por consulta)
            let groups = [];
            for (let i = 0; i < productIDs.length; i += 20) {
                groups.push(productIDs.slice(i, i + 20));
            }

            // ✅ Obtener detalles de los productos en lotes de 20
            let requests = groups.map(group => {
                let ids = group.join(",");
                return fetch(`${proxyUrl}productos/detalles?ids=${ids}`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" }
                }).then(res => res.json());
            });

            let responses = await Promise.all(requests);

            // ✅ Limpiar la tabla antes de mostrar los productos
            tableBody.innerHTML = "";

            // ✅ Mostrar los productos obtenidos
            responses.forEach(products => {
                products.forEach(item => {
                    if (item.body && item.body.id) {
                        let row = `<tr>
                            <td>${item.body.id}</td>
                            <td>${item.body.title}</td>
                            <td>${item.body.available_quantity}</td>
                        </tr>`;
                        tableBody.innerHTML += row;
                    }
                });
            });

        } catch (error) {
            console.error("Error al obtener datos:", error);
            document.getElementById("stockTable").innerHTML = `<tr><td colspan="3" style="color: red;">Error al obtener productos</td></tr>`;
        }
    }
</script>
